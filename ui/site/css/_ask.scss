/*
  Please don't use BEM in conjunction with parent selector here. Up to two levels of nesting is
  tolerated.  Nothing depends on this so scoped item element styles with brief class names that
  express intent is the goal
*/
$c-contrast-font: if($theme-light, #444, #ddd);
$c-neutral: if($theme-light, #ccc, #777);
$c-box-border: if($theme-light, #ddd, #484848);
$c-bg-hover: $c-box-border;
$gap: 8px; // needs to be independent of font-size, adjust to space things out.

// ask-container has one child that is replaced on every xhr request
div.ask-container {
  display: flex;

  // formatting modifier corresponding to 'stretch' tag in ask markup
  &.stretch {
    flex-direction: column;
    align-items: stretch;
  }
}

// main ask class has a legend/header, body, footer in block layout
fieldset.ask {
  margin-bottom: 2 * $gap;
  padding: 0 (3 * $gap) $gap (2 * $gap);
  width: 100%;
  font-size: 1.2rem;
  line-height: normal;
  border: solid 1px $c-box-border;

  legend {
    width: 100%;
  }

  // currently just the number of votes/respondents on a concluded ask
  > label {
    margin: $gap;
    flex-basis: 100%;
    font-weight: bold;
  }

  // defaults for header, body, footer
  & > * {
    display: flex;
    align-items: center;
    flex-direction: row;
  }
}

span.ask__header {
  display: flex;
  flex: 1 0 100%;
  justify-content: space-between;

  // the question
  label {
    flex: auto;
    margin: 0 $gap;
    padding-bottom: $gap;
    font-size: 1.3em;
  }

  // icon buttons in the top right
  .action {
    @extend %data-icon;
    margin-#{$end-direction}: $gap / 2;
    margin-bottom: $gap;
    flex: initial;
    justify-self: flex-end;
    background: none;
    border: none;
    outline: none;
    opacity: 1;
    cursor: pointer;

    &::before {
      vertical-align: top;
      font-size: 1.2em;
    }

    // for mods or the poll creator
    &.admin {
      color: $c-link;
      &::before {
        content: '';
      }
      &:hover {
        color: $c-link-hover;
      }
    }
    // the red x will unset a submitted vote,
    &.unset {
      visibility: hidden;
      color: if($theme-light, #f66, #c33);
      &::before {
        content: '';
      }
      &:hover {
        color: if($theme-light, #c33, #f66);
      }
      &.visible {
        visibility: visible;
      }
    }
  }
}

div.ask__footer {
  margin: $gap 0;
  display: grid;
  grid-template-columns: auto max-content;

  // feedback prompt or quiz reveal
  label {
    margin: 0 0 $gap $gap;
    grid-column: 1/3;
  }

  // the input text feield for feedback
  .feedback-text {
    margin: 0 0 $gap $gap;
    padding: 0.4em;
  }

  // the submit button for feedback text
  .feedback-submit {
    @extend %data-icon, %flex-around;
    visibility: hidden;

    input {
      margin: 0 0 $gap (2 * $gap);
      padding: $gap 1.2em;
    }

    &.success {
      visibility: visible;
      color: $c-secondary;

      & > input {
        visibility: hidden;
      }

      &::after {
        position: absolute;
        content: '';
      }
    }

    &.dirty {
      visibility: visible;
    }
  }

  // optional feedback results
  .feedback-results {
    grid-column: 1/3;
    display: grid;
    grid-template-columns: max-content auto;
    padding: 0 (2 * $gap) $gap $gap;
    label {
      grid-column: 1/3;
      font-size: 1.3em;
      margin: 0 0 $gap 0;
    }
    div {
      margin: 0 $gap;
    }
  }
}

// the main body - a flex layout of Ask.choices
div.ask__choices {
  margin: $gap 0 $gap 0;
  display: flex;
  flex-flow: row wrap;
  align-items: flex-start;

  // a single clickable/draggable choice button
  .choice,
  .exclusive-choice,
  .ranked-choice {
    @extend %metal, %box-radius;
    margin: 0 0 $gap $gap;
    padding: $gap (2 * $gap);
    flex: initial;
    display: inline-block;
    text-align: center;
    user-select: none;

    label {
      pointer-events: none;
    }

    // modifier corresponds to 'stretch' tag in ask markup
    &.stretch {
      flex: auto;
    }
  }

  // a draggable choice button
  .ranked-choice {
    @extend %lighten-hover;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;

    &.dragging {
      opacity: 0.3;
    }
    ::after {
      content: '';
    }

    // grey rank badge (unsubmitted)
    > div {
      margin-#{$start-direction}: -$gap;
      margin-#{$end-direction}: $gap;
      width: 1.7em;
      height: 1.7em;
      visibility: visible;
      border-radius: 100%;
      background: if($theme-light, #bbb, #666);
      border: 1px solid if($theme-light, #aaa, #666);
      color: if($theme-light, #ddd, #000);
      text-align: center;
      font-size: 0.7em;
      font-weight: bold;
    }

    // green rank badge (unsubmitted)
    &.badge > div {
      background: $c-secondary;
    }

    // ask-specific transparent background (overrides %metal)
    @if $theme == 'transp' {
      background: hsla(0deg, 0%, 50%, 0.3);
    }
  }

  // vertical ask drag cursor
  hr {
    margin: 0 0 $gap ($gap / 2);
    width: 100%;
    height: 2px;
    display: block;
    border-top: 1px solid $c-neutral;
    border-bottom: 1px solid $c-box-border;
  }

  // horizontal ask drag cursor (I-beam)
  .cursor {
    margin: 0 0 0 $gap;
    padding: 0;
    width: 2 * $gap;
    text-align: center;

    // I-beam icon
    &::after {
      @extend %data-icon;
      margin-#{$start-direction}: -$gap;
      font-size: 2.1em;
      color: if($theme-light, #bbb, $c-font);
      text-align: center;
      content: '';
    }
  }

  // mouseover for clickable choices
  %lighten-hover {
    color: $c-contrast-font;

    &:hover {
      box-shadow: inset 0 0 1px 100px hsla(0, 0%, 100%, if($theme-light, 0.3, 0.1));
    }
  }

  // ask choice that can be clicked
  .enabled {
    @extend %lighten-hover;
    cursor: pointer;

    @if $theme-light {
      background: linear-gradient(hsl(0deg, 0%, 96%) 0%, hsl(0deg, 0%, 90%) 100%);
    } @else if $theme == 'dark' {
      background: linear-gradient(hsl(0deg, 0%, 27%) 0%, hsl(0deg, 0%, 19%) 100%);
    } @else {
      background: hsla(0deg, 0%, 50%, 0.3);
    }
  }

  // selected choice registered in db - can be clicked to unset
  .selected {
    @extend %lighten-hover;
    cursor: pointer;
    color: white;
    background: linear-gradient(hsl(209, 79%, 58%) 0%, hsl(209, 79%, 52%) 100%);
  }

  // unavailable, cannot be clicked
  .disabled,
  .wrong {
    background: none;
  }

  .correct {
    color: white;
    background: linear-gradient(hsl(88deg, 62%, 44%) 0%, hsl(88deg, 62%, 38%) 100%);
  }

  .wrong {
    // transforms for the red x on wrong answers
    position: relative;

    &:before,
    &:after {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 5em;
      height: 4px;
      background: hsla(0, 100%, 60%, 0.5);
      transform: translate(-50%, -50%) rotate(-20deg);
      content: '';
    }

    &:after {
      transform: translate(-50%, -50%) rotate(20deg);
    }
  }

  // formatting modifier corresponding to vertical tag in ask markup
  &.vertical {
    flex-flow: column;
  }

  // formatting modifier corresponding to center tag in ask markup
  &.center {
    align-items: center;
    justify-content: center;
  }
}

div.ask__graph,
div.ask__rank-graph {
  margin: 0 $gap (2 * $gap) $gap;
  display: grid;
  grid-template-columns: fit-content(40%) max-content auto;
  grid-auto-rows: 1fr;
  align-items: center;

  div {
    margin: $gap $gap 0 $gap;
    user-select: none;
  }
  .votes-text {
    margin-right: 0;
    text-align: end;
  }
  .set-width {
    height: 75%;
    min-width: 0.2em;
    background: $c-primary;
  }
}

div.ask__rank-graph {
  grid-template-columns: fit-content(40%) auto;
}
